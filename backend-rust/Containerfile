# Inspiration courtesy of:
# * https://gitlab.com/cocainefarm/gnulag/catinator/-/blob/master/Containerfile
# * https://gitlab.com/cocainefarm/pastor/-/blob/master/Containerfile

# ------------------------------------------------------------------------------
# Cargo Build Stage
# ------------------------------------------------------------------------------

FROM rust:1.53-alpine as cargo-build

RUN apk add openssl-dev

RUN rustup default nightly && rustup update

WORKDIR /work

COPY . .

RUN apk add --no-cache musl-dev
RUN cargo build --release

# ------------------------------------------------------------------------------
# Final Stage
# ------------------------------------------------------------------------------

FROM alpine:3.13

RUN apk add openssl
RUN adduser rocket -D

WORKDIR /app

COPY --from=cargo-build /work/target/release/k8s-dashboard-backend .
COPY --from=cargo-build /work/Rocket.toml .

USER rocket

CMD ["./k8s-dashboard-backend"]
